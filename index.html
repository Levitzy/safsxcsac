<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Update the viewport meta tag for better mobile rendering -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Discord Bot Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="flex flex-col h-full">
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-xl font-bold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09-.01-.02-.04-.03-.07-.03-1.5.26-2.93.71-4.27 1.33-.01 0-.02.01-.03.02-2.72 4.07-3.47 8.03-3.1 11.95 0 .02.01.04.03.05 1.8 1.32 3.53 2.12 5.24 2.65.03.01.06 0 .07-.02.4-.55.76-1.13 1.07-1.74.02-.04 0-.08-.04-.09-.57-.22-1.11-.48-1.64-.78-.04-.02-.04-.08-.01-.11.11-.08.22-.17.33-.25.02-.02.05-.02.07-.01 3.44 1.57 7.15 1.57 10.55 0 .02-.01.05-.01.07.01.11.09.22.17.33.26.04.03.04.09-.01.11-.52.31-1.07.56-1.64.78-.04.01-.05.06-.04.09.32.61.68 1.19 1.07 1.74.03.02.06.03.09.02 1.72-.53 3.45-1.33 5.25-2.65.02-.01.03-.03.03-.05.44-4.53-.73-8.46-3.1-11.95-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12 0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12 0 1.17-.83 2.12-1.89 2.12z"/>
                    </svg>
                    <span class="nav-text">Bot Admin</span>
                </h1>
            </div>
            <ul class="nav flex-col mb-auto p-2">
                <li class="nav-item">
                    <a href="#dashboard" class="nav-link active">
                        <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#admin-management" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span class="nav-text">Admin Management</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#bot-info" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="nav-text">Bot Information</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#system-stats" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <span class="nav-text">System Stats</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#settings" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="nav-text">Settings</span>
                    </a>
                </li>
            </ul>
            <div class="p-4 mt-auto border-t border-gray-200">
                <div class="flex items-center">
                    <div class="rounded-full bg-purple-100 p-2 mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <div class="nav-text w-full">
                        <small class="block text-gray-500">Bot Status</small>
                        <div class="flex items-center justify-between">
                            <span class="flex items-center">
                                <span class="bg-green-500 rounded-full mr-1" style="width: 8px; height: 8px;"></span>
                                <span class="text-gray-700">Online</span>
                            </span>
                            <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full" id="sidebar-uptime">0s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toggle Button -->
    <div class="sidebar-toggle" id="sidebar-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" id="toggle-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <div class="container mx-auto p-0">
            <!-- Dashboard Section -->
            <section id="dashboard" class="mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
                    <div>
                        <button class="md-button-outlined mr-2" onclick="refreshData()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Refresh Data
                        </button>
                        <button class="md-button-filled" onclick="logout()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            Logout
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card md-elevation-1">
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                        </div>
                        <div class="stat-value" id="admin-count">0</div>
                        <div class="stat-label">Admins</div>
                    </div>
                    <div class="stat-card md-elevation-1">
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <div class="stat-value" id="command-count">0</div>
                        <div class="stat-label">Commands</div>
                    </div>
                    <div class="stat-card md-elevation-1">
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="stat-value" id="uptime">0s</div>
                        <div class="stat-label">Uptime</div>
                        <div class="progress-thin mt-2 bg-gray-200">
                            <div id="uptime-progress" class="progress-bar bg-green-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="stat-card md-elevation-1">
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </div>
                        <div class="stat-value" id="active-users">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="lg:col-span-2">
                        <div class="md-card md-elevation-1 h-full">
                            <div class="p-6 border-b border-gray-200">
                                <h2 class="text-lg font-semibold text-gray-900">System Overview</h2>
                            </div>
                            <div class="p-6">
                                <canvas id="system-overview-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="md-card md-elevation-1 h-full">
                            <div class="p-6 border-b border-gray-200">
                                <h2 class="text-lg font-semibold text-gray-900">Memory Usage</h2>
                            </div>
                            <div class="p-6">
                                <div class="memory-usage">
                                    <canvas id="memory-chart"></canvas>
                                </div>
                                <div class="mt-4">
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-700">RSS</span>
                                        <span id="memory-rss" class="text-sm font-medium text-gray-900">0 MB</span>
                                    </div>
                                    <div class="progress-thin mb-3 bg-gray-200">
                                        <div id="memory-rss-bar" class="progress-bar bg-purple-500" style="width: 0%"></div>
                                    </div>
                                    
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-700">Heap Total</span>
                                        <span id="memory-heap-total" class="text-sm font-medium text-gray-900">0 MB</span>
                                    </div>
                                    <div class="progress-thin mb-3 bg-gray-200">
                                        <div id="memory-heap-total-bar" class="progress-bar bg-green-500" style="width: 0%"></div>
                                    </div>
                                    
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-700">Heap Used</span>
                                        <span id="memory-heap-used" class="text-sm font-medium text-gray-900">0 MB</span>
                                    </div>
                                    <div class="progress-thin bg-gray-200">
                                        <div id="memory-heap-used-bar" class="progress-bar bg-yellow-500" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="md-card md-elevation-1 mb-8">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Command Prefix</h2>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <label for="prefix" class="block mb-2 text-sm font-medium text-gray-900">Set Command Prefix</label>
                            <div class="flex">
                                <input type="text" id="prefix" class="md-input mr-2" placeholder="Enter command prefix (leave empty for no prefix)">
                                <button class="md-button-filled" type="button" onclick="updatePrefix()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    Update
                                </button>
                            </div>
                            <p class="mt-2 text-sm text-gray-600">Current prefix: <span id="current-prefix" class="font-semibold"></span></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Admin Management Section -->
            <section id="admin-management" class="mb-8" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Admin Permission Management</h2>
                
                <div class="md-card md-elevation-1 mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">GitHub Integration</h3>
                    </div>
                    <div class="p-6">
                        <div id="github-warning" class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-blue-800">GitHub Configuration</h4>
                                    <p class="text-sm text-blue-700 mt-1">Admin permissions are managed directly in your GitHub repository. Changes made here will update the file on GitHub.</p>
                                    <p class="text-sm text-blue-700 mt-1">GitHub file URL: <code id="github-url" class="font-semibold">Loading...</code></p>
                                </div>
                            </div>
                            <div id="github-not-configured-warning" class="bg-red-50 border-l-4 border-red-500 p-4 mt-4" style="display: none;">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h4 class="text-sm font-medium text-red-800">GitHub API Not Configured</h4>
                                        <p class="text-sm text-red-700 mt-1">The bot server is not fully set up to write changes to GitHub. Updates made here might be in-memory only and lost on restart.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <p class="text-sm text-gray-700 mb-2">Required <code>admin_ids.json</code> format on GitHub (example):</p>
                            <div class="relative">
                                <pre id="admin-json-format" class="bg-gray-800 text-gray-100 rounded-lg p-4 text-sm overflow-x-auto">{
  "ADMIN_PERMISSIONS": {
    "123456789012345678": ["fbcreatev2", "anotherCommand"],
    "987654321098765432": ["all"]
  }
}</pre>
                                <button class="absolute top-2 right-2 bg-gray-700 text-white p-1 rounded hover:bg-gray-600" onclick="copyToClipboard('admin-json-format', true)">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button class="md-button-outlined" onclick="refreshAdminPermissionsFromServer()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Refresh from GitHub
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="md-card md-elevation-1 mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Add New Admin</h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div class="md:col-span-5">
                                <label for="newAdminId" class="block mb-2 text-sm font-medium text-gray-900">Discord User ID</label>
                                <input type="text" id="newAdminId" class="md-input" placeholder="17-19 digit ID">
                            </div>
                            <div class="md:col-span-5">
                                <label for="newAdminPerms" class="block mb-2 text-sm font-medium text-gray-900">Initial Permissions</label>
                                <input type="text" id="newAdminPerms" class="md-input" placeholder="e.g., cmd1, cmd2 or all">
                            </div>
                            <div class="md:col-span-2 flex items-end">
                                <button class="md-button-filled w-full" type="button" onclick="addAdmin()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Add
                                </button>
                            </div>
                        </div>
                        <p class="mt-2 text-sm text-gray-600">For permissions, use comma-separated command names or "all" for full access.</p>
                    </div>
                </div>
                
                <div class="md-card md-elevation-1 mb-6">
                    <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Current Admins & Permissions</h3>
                        <button class="md-button-text" onclick="updateAdminJsonDisplay()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Refresh
                        </button>
                    </div>
                    <div class="p-6">
                        <div id="adminList" class="mb-4">
                            <!-- Admin items will be rendered here -->
                        </div>
                    </div>
                </div>
                
                <div class="md-card md-elevation-1">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Export Current Admin Permissions (JSON)</h3>
                    </div>
                    <div class="p-6">
                        <div class="relative">
                            <pre id="current-admin-json" class="bg-gray-800 text-gray-100 rounded-lg p-4 text-sm overflow-x-auto"></pre>
                            <button class="absolute top-2 right-2 bg-gray-700 text-white p-1 rounded hover:bg-gray-600" onclick="copyToClipboard('current-admin-json', true)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Bot Information Section -->
            <section id="bot-info" class="mb-8" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Bot Information</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md-card md-elevation-1 h-full">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">Commands</h3>
                        </div>
                        <div class="p-6">
                            <p id="command-count-details" class="mb-4 text-gray-700">Loading...</p>
                            <div id="admin-commands-list-display" class="mt-4 max-h-60 overflow-y-auto">
                                <p class="text-sm text-gray-500">Admin commands will be listed here.</p>
                            </div>
                        </div>
                    </div>
                    <div class="md-card md-elevation-1 h-full">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">System Status</h3>
                        </div>
                        <div class="p-6">
                            <div class="flex items-center mb-6">
                                <div class="mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700">Uptime</h4>
                                    <p id="uptime-detail" class="text-xl font-bold text-gray-900">Loading...</p>
                                </div>
                            </div>
                            <div class="flex items-center mb-6">
                                <div class="mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700">Commands Executed</h4>
                                    <p id="commands-executed" class="text-xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700">Server Status</h4>
                                    <p class="text-xl font-bold text-gray-900">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            Online
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="md-card md-elevation-1 mt-6">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Last Activity</h3>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Last Command</td>
                                        <td id="last-command-time" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Never</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Active Users</td>
                                        <td id="active-users-detail" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">0</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Error Count</td>
                                        <td id="error-count" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">0</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Server Start Time</td>
                                        <td id="server-start-time" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Unknown</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- System Stats Section -->
            <section id="system-stats" class="mb-8" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">System Statistics</h2>
                
                <div class="md-card md-elevation-1 mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Memory Usage Over Time</h3>
                    </div>
                    <div class="p-6">
                        <canvas id="memory-history-chart" height="250"></canvas>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md-card md-elevation-1">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">System Information</h3>
                        </div>
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Node.js Version</td>
                                            <td id="nodejs-version" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Platform</td>
                                            <td id="platform" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Architecture</td>
                                            <td id="architecture" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">CPU Cores</td>
                                            <td id="cpu-cores" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Total Memory</td>
                                            <td id="total-memory" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="md-card md-elevation-1">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">Performance Metrics</h3>
                        </div>
                        <div class="p-6">
                            <div class="mb-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm text-gray-700">Memory Usage</span>
                                    <span id="memory-usage-percent" class="text-sm font-medium text-gray-900">0%</span>
                                </div>
                                <div class="progress-thin bg-gray-200">
                                    <div id="memory-usage-bar" class="progress-bar bg-purple-500" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm text-gray-700">Heap Usage</span>
                                    <span id="heap-usage-percent" class="text-sm font-medium text-gray-900">0%</span>
                                </div>
                                <div class="progress-thin bg-gray-200">
                                    <div id="heap-usage-bar" class="progress-bar bg-green-500" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm text-gray-700">Command Execution Rate</span>
                                    <span id="command-rate" class="text-sm font-medium text-gray-900">0/min</span>
                                </div>
                                <div class="progress-thin bg-gray-200">
                                    <div id="command-rate-bar" class="progress-bar bg-yellow-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Settings Section -->
            <section id="settings" class="mb-8" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Settings</h2>
                
                <div class="md-card md-elevation-1 mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Admin Panel Settings</h3>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <label for="refresh-interval" class="block mb-2 text-sm font-medium text-gray-900">Auto-Refresh Interval</label>
                            <select id="refresh-interval" class="md-input">
                                <option value="0">Manual refresh only</option>
                                <option value="5000">Every 5 seconds</option>
                                <option value="10000">Every 10 seconds</option>
                                <option value="30000" selected>Every 30 seconds</option>
                                <option value="60000">Every minute</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label for="session-timeout" class="block mb-2 text-sm font-medium text-gray-900">Session Timeout</label>
                            <select id="session-timeout" class="md-input">
                                <option value="3600000">1 hour</option>
                                <option value="7200000">2 hours</option>
                                <option value="14400000">4 hours</option>
                                <option value="28800000">8 hours</option>
                                <option value="86400000" selected>24 hours</option>
                            </select>
                        </div>
                        
                        <button class="md-button-filled" onclick="saveSettings()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            Save Settings
                        </button>
                    </div>
                </div>
                
                <div class="md-card md-elevation-1">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Change Admin Token</h3>
                    </div>
                    <div class="p-6">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700">Changing the admin token will immediately log out all current sessions. Make sure to remember your new token!</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="current-token" class="block mb-2 text-sm font-medium text-gray-900">Current Admin Token</label>
                            <input type="password" id="current-token" class="md-input" placeholder="Enter current token">
                        </div>
                        
                        <div class="mb-4">
                            <label for="new-token" class="block mb-2 text-sm font-medium text-gray-900">New Admin Token</label>
                            <input type="password" id="new-token" class="md-input" placeholder="Enter new token">
                        </div>
                        
                        <div class="mb-4">
                            <label for="confirm-token" class="block mb-2 text-sm font-medium text-gray-900">Confirm New Token</label>
                            <input type="password" id="confirm-token" class="md-input" placeholder="Confirm new token">
                        </div>
                        
                        <button class="md-button-filled bg-red-600 hover:bg-red-700" onclick="changeAdminToken()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                            </svg>
                            Change Token
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Notification container will be added by notification-ui.js -->

    <script type="module">
        import notificationSystem from './notification-system.js';
        import { initNotificationUI, showToast } from './notification-ui.js';
        import { initAdminPermissionDialog, openAdminPermissionDialog } from './admin-permission-dialog.js';
        
        // Global variables
        let currentConfig = {
            PREFIX: "",
            ADMIN_PERMISSIONS: {},
            ADMIN_CONFIG_URL: "",
            GITHUB_CONFIGURED: false
        };
        let allBotCommands = [];
        let systemStats = {};
        let sidebarCollapsed = false;
        let refreshInterval = 30000; // Default refresh interval: 30 seconds
        let refreshTimer = null;
        let memoryChart = null;
        let systemOverviewChart = null;
        let memoryHistoryChart = null;
        let memoryHistory = {
            labels: [],
            rss: [],
            heapTotal: [],
            heapUsed: []
        };
        
        // Authentication
        function checkAuthentication() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }
        
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = '/login.html';
        }
        
        // API helpers
        function getAuthHeaders() {
            const token = localStorage.getItem('adminToken');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        
        async function fetchWithAuth(url, options = {}) {
            const headers = { ...getAuthHeaders(), ...options.headers };
            const response = await fetch(url, { ...options, headers });
            
            if (response.status === 401) {
                logout();
                return null;
            }
            
            return response;
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuthentication()) return;
            
            // Initialize notification system
            initNotificationUI();
            
            // Initialize admin permission dialog
            initAdminPermissionDialog(allBotCommands, {}, saveAdminPermissions);
            
            // Setup navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    const targetId = this.getAttribute('href').substring(1);
                    document.querySelectorAll('section').forEach(section => {
                        section.style.display = section.id === targetId ? 'block' : 'none';
                    });
                });
            });
            
            // Setup sidebar toggle
            document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
            
            // Initialize charts
            initializeCharts();
            
            // Load initial data
            refreshData();
            
            // Setup auto-refresh
            document.getElementById('refresh-interval').addEventListener('change', function() {
                refreshInterval = parseInt(this.value);
                if (refreshTimer) {
                    clearInterval(refreshTimer);
                    refreshTimer = null;
                }
                
                if (refreshInterval > 0) {
                    refreshTimer = setInterval(refreshData, refreshInterval);
                }
            });
            
            // Start auto-refresh if enabled
            if (refreshInterval > 0) {
                refreshTimer = setInterval(refreshData, refreshInterval);
            }
            
            // Show welcome notification
            showToast('Welcome', 'Admin panel loaded successfully', 'success', true);
        });
        
        function initializeCharts() {
            // Memory chart (donut)
            const memoryCtx = document.getElementById('memory-chart').getContext('2d');
            memoryChart = new Chart(memoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Heap Used', 'Heap Available', 'Other Memory'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#EADDFF', '#6750A4', '#79747E']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // System overview chart (line)
            const sysCtx = document.getElementById('system-overview-chart').getContext('2d');
            systemOverviewChart = new Chart(sysCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Commands Executed',
                        data: [],
                        borderColor: '#6750A4',
                        backgroundColor: 'rgba(103, 80, 164, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Memory history chart (line)
            const memHistoryCtx = document.getElementById('memory-history-chart').getContext('2d');
            memoryHistoryChart = new Chart(memHistoryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'RSS',
                            data: [],
                            borderColor: '#6750A4',
                            backgroundColor: 'rgba(103, 80, 164, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Heap Total',
                            data: [],
                            borderColor: '#7965AF',
                            backgroundColor: 'rgba(121, 101, 175, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Heap Used',
                            data: [],
                            borderColor: '#9A82DB',
                            backgroundColor: 'rgba(154, 130, 219, 0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Memory (MB)'
                            }
                        }
                    }
                }
            });
        }
        
        function updateCharts() {
            if (!systemStats || !systemStats.memory) return;
            
            // Update memory donut chart
            const heapUsed = systemStats.memory.heapUsed;
            const heapAvailable = systemStats.memory.heapTotal - systemStats.memory.heapUsed;
            const otherMemory = systemStats.memory.rss - systemStats.memory.heapTotal;
            
            memoryChart.data.datasets[0].data = [heapUsed, heapAvailable, otherMemory];
            memoryChart.update();
            
            // Update memory history
            const now = new Date().toLocaleTimeString();
            memoryHistory.labels.push(now);
            memoryHistory.rss.push(systemStats.memory.rss);
            memoryHistory.heapTotal.push(systemStats.memory.heapTotal);
            memoryHistory.heapUsed.push(systemStats.memory.heapUsed);
            
            // Keep only the last 10 data points
            if (memoryHistory.labels.length > 10) {
                memoryHistory.labels.shift();
                memoryHistory.rss.shift();
                memoryHistory.heapTotal.shift();
                memoryHistory.heapUsed.shift();
            }
            
            // Update memory history chart
            memoryHistoryChart.data.labels = memoryHistory.labels;
            memoryHistoryChart.data.datasets[0].data = memoryHistory.rss;
            memoryHistoryChart.data.datasets[1].data = memoryHistory.heapTotal;
            memoryHistoryChart.data.datasets[2].data = memoryHistory.heapUsed;
            memoryHistoryChart.update();
            
            // Update system overview chart (just a placeholder for now)
            if (systemOverviewChart.data.labels.length === 0) {
                // Initialize with some data points
                for (let i = 0; i < 10; i++) {
                    const time = new Date();
                    time.setMinutes(time.getMinutes() - (10 - i));
                    systemOverviewChart.data.labels.push(time.toLocaleTimeString());
                    systemOverviewChart.data.datasets[0].data.push(0);
                }
            }
            
            // Add latest data point
            systemOverviewChart.data.labels.push(now);
            systemOverviewChart.data.datasets[0].data.push(systemStats.commandsExecuted);
            
            // Keep only the last 10 data points
            if (systemOverviewChart.data.labels.length > 10) {
                systemOverviewChart.data.labels.shift();
                systemOverviewChart.data.datasets[0].data.shift();
            }
            
            systemOverviewChart.update();
        }
        
        async function refreshData() {
            showLoading();
            
            try {
                // Fetch system stats
                const statsResponse = await fetchWithAuth('/api/stats');
                if (statsResponse) {
                    systemStats = await statsResponse.json();
                    updateSystemStats();
                }
                
                // Fetch config
                const configResponse = await fetchWithAuth('/api/config');
                if (configResponse) {
                    currentConfig = await configResponse.json();
                    updateConfigDisplay();
                }
                
                // Fetch commands
                const commandsResponse = await fetchWithAuth('/api/commands');
                if (commandsResponse) {
                    const data = await commandsResponse.json();
                    allBotCommands = data.commands || [];
                    updateCommandsDisplay();
                }
                
                hideLoading();
                showToast('Data Refreshed', 'Dashboard data has been updated', 'info');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showToast('Error', 'Failed to refresh data: ' + error.message, 'error');
                hideLoading();
            }
        }

        function updateSystemStats() {
            if (!systemStats) return;
            
            // Update dashboard stats
            document.getElementById('admin-count').textContent = systemStats.adminCount || 0;
            document.getElementById('command-count').textContent = systemStats.commandCount || 0;
            document.getElementById('uptime').textContent = systemStats.uptimeFormatted || '0s';
            document.getElementById('sidebar-uptime').textContent = systemStats.uptimeFormatted || '0s';
            document.getElementById('active-users').textContent = systemStats.activeUsers || 0;
            document.getElementById('active-users-detail').textContent = systemStats.activeUsers || 0;
            document.getElementById('commands-executed').textContent = systemStats.commandsExecuted || 0;
            document.getElementById('error-count').textContent = systemStats.errors || 0;
            
            // Format and display last command time
            if (systemStats.lastCommandTime) {
                const lastCmdTime = new Date(systemStats.lastCommandTime);
                document.getElementById('last-command-time').textContent = lastCmdTime.toLocaleString();
            } else {
                document.getElementById('last-command-time').textContent = 'Never';
            }
            
            // Format and display server start time
            if (systemStats.serverStartTime) {
                const startTime = new Date(systemStats.serverStartTime);
                document.getElementById('server-start-time').textContent = startTime.toLocaleString();
                document.getElementById('uptime-detail').textContent = systemStats.uptimeFormatted || '0s';
                
                // Start the uptime counter if it hasn't been started yet
                if (!window.uptimeCounterStarted) {
                    startUptimeCounter();
                    window.uptimeCounterStarted = true;
                }
            } else {
                document.getElementById('server-start-time').textContent = 'Unknown';
            }
            
            // Update memory stats
            if (systemStats.memory) {
                document.getElementById('memory-rss').textContent = `${systemStats.memory.rss} MB`;
                document.getElementById('memory-heap-total').textContent = `${systemStats.memory.heapTotal} MB`;
                document.getElementById('memory-heap-used').textContent = `${systemStats.memory.heapUsed} MB`;
                
                // Update progress bars (assuming 8GB total memory for percentage calculation)
                const totalMemory = 8 * 1024; // 8GB in MB
                const rssPercent = (systemStats.memory.rss / totalMemory) * 100;
                const heapTotalPercent = (systemStats.memory.heapTotal / totalMemory) * 100;
                const heapUsedPercent = (systemStats.memory.heapUsed / systemStats.memory.heapTotal) * 100;
                
                document.getElementById('memory-rss-bar').style.width = `${Math.min(rssPercent, 100)}%`;
                document.getElementById('memory-heap-total-bar').style.width = `${Math.min(heapTotalPercent, 100)}%`;
                document.getElementById('memory-heap-used-bar').style.width = `${Math.min(heapUsedPercent, 100)}%`;
                
                // Update performance metrics
                document.getElementById('memory-usage-percent').textContent = `${Math.round(rssPercent)}%`;
                document.getElementById('memory-usage-bar').style.width = `${Math.min(rssPercent, 100)}%`;
                
                document.getElementById('heap-usage-percent').textContent = `${Math.round(heapUsedPercent)}%`;
                document.getElementById('heap-usage-bar').style.width = `${Math.min(heapUsedPercent, 100)}%`;
            }
            
            // Update charts
            updateCharts();
        }
        
        // Add this new function for real-time uptime counter
        function startUptimeCounter() {
            if (!systemStats || !systemStats.serverStartTime) return;
            
            const serverStartTime = new Date(systemStats.serverStartTime).getTime();
            
            // Update uptime every second
            setInterval(() => {
                const now = Date.now();
                const uptime = now - serverStartTime;
                const formattedUptime = formatUptime(uptime);
                
                // Update all uptime displays
                document.getElementById('uptime').textContent = formattedUptime;
                document.getElementById('uptime-detail').textContent = formattedUptime;
                document.getElementById('sidebar-uptime').textContent = formattedUptime;
                
                // Update progress bar (resets every day)
                const dayProgress = (uptime % (24 * 60 * 60 * 1000)) / (24 * 60 * 60 * 1000) * 100;
                document.getElementById('uptime-progress').style.width = `${dayProgress}%`;
            }, 1000);
        }
        
        function updateConfigDisplay() {
            document.getElementById('prefix').value = currentConfig.PREFIX || "";
            document.getElementById('current-prefix').textContent = currentConfig.PREFIX ? `"${currentConfig.PREFIX}"` : "None (empty)";
            document.getElementById('github-url').textContent = currentConfig.ADMIN_CONFIG_URL || "URL not configured";
            document.getElementById('github-not-configured-warning').style.display = !currentConfig.GITHUB_CONFIGURED ? 'block' : 'none';
            
            renderAdminList();
            updateAdminJsonDisplay();
        }
        
        function updateCommandsDisplay() {
            const totalCommands = allBotCommands.length;
            const adminOnlyCommands = allBotCommands.filter(cmd => cmd.admin_only);
            
            document.getElementById('command-count-details').textContent = `${totalCommands} commands loaded (${adminOnlyCommands.length} admin-only).`;
            
            const adminCmdDisplayEl = document.getElementById('admin-commands-list-display');
            adminCmdDisplayEl.innerHTML = ''; 
            
            if(adminOnlyCommands.length > 0) {
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2';
                adminOnlyCommands.forEach(cmd => {
                    const cmdItem = document.createElement('div');
                    cmdItem.className = 'px-3 py-2 bg-purple-100 text-purple-800 rounded-lg text-sm font-medium';
                    cmdItem.textContent = cmd.name;
                    grid.appendChild(cmdItem);
                });
                adminCmdDisplayEl.appendChild(grid);
            } else {
                adminCmdDisplayEl.innerHTML = '<div class="p-4 bg-gray-50 rounded-lg text-gray-500 text-sm">No admin-only commands found.</div>';
            }
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const toggleIcon = document.getElementById('toggle-icon');
            
            sidebarCollapsed = !sidebarCollapsed;
            
            if (sidebarCollapsed) {
                sidebar.classList.add('sidebar-collapsed');
                mainContent.classList.add('main-content-expanded');
                toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />';
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                mainContent.classList.remove('main-content-expanded');
                toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />';
            }
        }
        
        function updateAdminJsonDisplay() {
            const jsonElement = document.getElementById('current-admin-json');
            jsonElement.textContent = JSON.stringify({ ADMIN_PERMISSIONS: currentConfig.ADMIN_PERMISSIONS }, null, 2);
        }
        
        function copyToClipboard(elementId, isPreformatted = false) {
            const element = document.getElementById(elementId);
            const textToCopy = isPreformatted ? element.textContent : element.value;
            navigator.clipboard.writeText(textToCopy)
                .then(() => showToast('Copied', 'Text copied to clipboard', 'success'))
                .catch(err => showToast('Error', 'Failed to copy: ' + err, 'error'));
        }
        
        async function refreshAdminPermissionsFromServer() {
            showLoading();
            try {
                const response = await fetchWithAuth('/api/admin-permissions/refresh');
                const data = await response.json();
                
                if (data.success) {
                    currentConfig.ADMIN_PERMISSIONS = data.ADMIN_PERMISSIONS;
                    renderAdminList();
                    updateAdminJsonDisplay();
                    showToast('Success', data.message || 'Admin permissions refreshed from GitHub.', 'success');
                } else {
                    showToast('Error', 'Error refreshing admin permissions: ' + (data.message || data.error), 'error');
                }
            } catch (error) {
                showToast('Error', 'Network error refreshing admin permissions: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        function renderAdminList() {
            const adminListEl = document.getElementById('adminList');
            adminListEl.innerHTML = '';
            
            if (!currentConfig.ADMIN_PERMISSIONS || Object.keys(currentConfig.ADMIN_PERMISSIONS).length === 0) {
                adminListEl.innerHTML = '<div class="p-4 bg-gray-50 rounded-lg text-gray-500 text-sm">No admins configured. Add admin IDs and their permissions.</div>';
                return;
            }
            
            for (const adminId in currentConfig.ADMIN_PERMISSIONS) {
                const permissions = currentConfig.ADMIN_PERMISSIONS[adminId];
                const item = document.createElement('div');
                item.className = 'admin-item mb-4';
                
                let permsDisplay = '';
                if (permissions.includes('all')) {
                    permsDisplay = '<span class="md-chip md-chip-filled mr-2 mb-2">All Permissions</span>';
                } else if (permissions.length > 0) {
                    permsDisplay = permissions.map(p => `<span class="md-chip mr-2 mb-2">${p}</span>`).join('');
                } else {
                    permsDisplay = '<span class="md-chip bg-yellow-100 text-yellow-800 mr-2 mb-2">No Specific Permissions</span>';
                }

                item.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center">
                        <div class="mr-4 mb-3 mb-md-0">
                            <div class="flex items-center mb-2">
                                <span class="bg-purple-100 text-purple-800 text-xs px-2.5 py-1 rounded-full mr-2">Admin</span>
                                <strong class="font-mono">${adminId}</strong>
                            </div>
                            <div class="mt-2 flex flex-wrap">${permsDisplay}</div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="md-button-outlined" onclick="window.openEditAdminPermissionDialog('${adminId}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                Edit
                            </button>
                            <button class="md-button-outlined bg-red-50 text-red-600 border-red-200 hover:bg-red-100" onclick="window.removeAdmin('${adminId}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Remove
                            </button>
                        </div>
                    </div>`;
                adminListEl.appendChild(item);
            }
        }
        
        function openEditAdminPermissionDialog(adminId) {
            const permissions = currentConfig.ADMIN_PERMISSIONS[adminId] || [];
            openAdminPermissionDialog(adminId, allBotCommands, permissions);
        }
        
        function saveAdminPermissions(adminId, permissions) {
            const newAdminConfig = { ...currentConfig.ADMIN_PERMISSIONS };
            newAdminConfig[adminId] = permissions;
            
            updateAdminPermissionsOnServer(newAdminConfig)
                .then(() => {
                    showToast('Success', 'Admin permissions updated successfully', 'success');
                })
                .catch(error => {
                    showToast('Error', 'Failed to update admin permissions: ' + error.message, 'error');
                });
        }
        
        async function updateAdminPermissionsOnServer(newAdminPermsObject) {
            if (!currentConfig.GITHUB_CONFIGURED) {
                showToast('Warning', 'GitHub API not configured on server. Changes may not persist after restart.', 'warning');
            }

            showLoading();
            
            try {
                const response = await fetchWithAuth('/api/admin-permissions/update', {
                    method: 'POST',
                    body: JSON.stringify({ admin_permissions: newAdminPermsObject })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentConfig.ADMIN_PERMISSIONS = data.ADMIN_PERMISSIONS || newAdminPermsObject;
                    renderAdminList();
                    updateAdminJsonDisplay();
                    hideLoading();
                    return data;
                } else {
                    hideLoading();
                    throw new Error(data.message || data.error || 'Unknown error updating permissions');
                }
            } catch (error) {
                hideLoading();
                throw error;
            }
        }
        
        async function addAdmin() {
            const newAdminIdInput = document.getElementById('newAdminId');
            const newAdminPermsInput = document.getElementById('newAdminPerms');
            const adminId = newAdminIdInput.value.trim();
            const permsStr = newAdminPermsInput.value.trim();
            
            if (!adminId) {
                showToast('Validation Error', 'Please enter a valid Discord User ID', 'error');
                return;
            }
            if (!/^\d{17,19}$/.test(adminId)) {
                showToast('Validation Error', 'Invalid Discord ID format. IDs are 17-19 digits long.', 'error');
                return;
            }
            if (currentConfig.ADMIN_PERMISSIONS.hasOwnProperty(adminId)) {
                showToast('Validation Error', 'This admin ID already exists. Edit their permissions instead.', 'error');
                return;
            }
            if (!permsStr) {
                showToast('Validation Error', 'Please enter initial permissions (e.g., command names or "all").', 'error');
                return;
            }
            
            const permissionsArray = permsStr.split(',').map(p => p.trim()).filter(p => p.length > 0);
            if (permissionsArray.length === 0) {
                showToast('Validation Error', 'Permissions cannot be empty. Use "all" or command names.', 'error');
                return;
            }

            const newAdminConfig = { ...currentConfig.ADMIN_PERMISSIONS };
            newAdminConfig[adminId] = permissionsArray;

            try {
                await updateAdminPermissionsOnServer(newAdminConfig);
                newAdminIdInput.value = '';
                newAdminPermsInput.value = '';
                showToast('Success', `Admin ${adminId} added successfully`, 'success');
            } catch (err) {
                showToast('Error', `Failed to add admin: ${err.message}`, 'error');
            }
        }
        
        async function removeAdmin(adminIdToRemove) {
            if (!confirm(`Are you sure you want to remove admin ID ${adminIdToRemove}? This will update the file on GitHub.`)) {
                return;
            }
            
            const newAdminConfig = { ...currentConfig.ADMIN_PERMISSIONS };
            delete newAdminConfig[adminIdToRemove];
            
            try {
                await updateAdminPermissionsOnServer(newAdminConfig);
                showToast('Success', `Admin ${adminIdToRemove} removed successfully`, 'success');
            } catch (err) {
                showToast('Error', `Failed to remove admin: ${err.message}`, 'error');
            }
        }
        
        async function updatePrefix() {
            const newPrefix = document.getElementById('prefix').value;
            showLoading();
            
            try {
                const response = await fetchWithAuth('/api/config', {
                    method: 'POST',
                    body: JSON.stringify({ PREFIX: newPrefix })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentConfig.PREFIX = newPrefix;
                    document.getElementById('current-prefix').textContent = newPrefix ? `"${newPrefix}"` : "None (empty)";
                    showToast('Success', data.message || 'Prefix updated successfully!', 'success');
                } else {
                    showToast('Error', 'Error updating prefix: ' + (data.message || data.error), 'error');
                }
            } catch (error) {
                showToast('Error', 'Network error updating prefix: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        function saveSettings() {
            refreshInterval = parseInt(document.getElementById('refresh-interval').value);
            
            // Clear existing timer
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
            
            // Set new timer if needed
            if (refreshInterval > 0) {
                refreshTimer = setInterval(refreshData, refreshInterval);
            }
            
            showToast('Success', 'Settings saved successfully!', 'success');
        }
        
        function changeAdminToken() {
            const currentToken = document.getElementById('current-token').value;
            const newToken = document.getElementById('new-token').value;
            const confirmToken = document.getElementById('confirm-token').value;
            
            if (!currentToken || !newToken || !confirmToken) {
                showToast('Error', 'All fields are required', 'error');
                return;
            }
            
            if (newToken !== confirmToken) {
                showToast('Error', 'New token and confirmation do not match', 'error');
                return;
            }
            
            // This is a placeholder - in a real implementation, this would call an API endpoint
            showToast('Success', 'Admin token changed successfully! You will be logged out.', 'success');
            
            // Simulate logout after token change
            setTimeout(() => {
                logout();
            }, 2000);
        }
        
        function showLoading() { 
            document.getElementById('loading').style.display = 'flex'; 
        }
        
        function hideLoading() { 
            document.getElementById('loading').style.display = 'none'; 
        }
        
        // Helper function to format uptime
        function formatUptime(uptimeMs) {
            const totalSeconds = Math.floor(uptimeMs / 1000);
            const days = Math.floor(totalSeconds / (60 * 60 * 24));
            const hours = Math.floor((totalSeconds % (60 * 60 * 24)) / (60 * 60));
            const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
            const seconds = totalSeconds % 60;

            let formatted = "";
            if (days > 0) formatted += `${days}d `;
            if (hours > 0) formatted += `${hours}h `;
            if (minutes > 0) formatted += `${minutes}m `;
            formatted += `${seconds}s`;

            return formatted;
        }
        
        // Expose functions to global scope for HTML onclick handlers
        window.openEditAdminPermissionDialog = openEditAdminPermissionDialog;
        window.removeAdmin = removeAdmin;
        window.addAdmin = addAdmin;
        window.updatePrefix = updatePrefix;
        window.refreshAdminPermissionsFromServer = refreshAdminPermissionsFromServer;
        window.copyToClipboard = copyToClipboard;
        window.saveSettings = saveSettings;
        window.changeAdminToken = changeAdminToken;
        window.logout = logout;
        window.refreshData = refreshData;
    </script>
    <!-- Add this script to the bottom of the file, just before the closing </body> tag -->
    <script>
      // Fix for mobile Safari 100vh issue
      function setMobileHeight() {
        document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
      }
      
      // Set initial height
      setMobileHeight();
      
      // Update on resize and orientation change
      window.addEventListener('resize', setMobileHeight);
      window.addEventListener('orientationchange', setMobileHeight);
      
      // Improve mobile sidebar behavior
      document.addEventListener('DOMContentLoaded', function() {
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
          const sidebar = document.getElementById('sidebar');
          const sidebarToggle = document.getElementById('sidebar-toggle');
          
          if (window.innerWidth <= 768 && 
              sidebar.classList.contains('sidebar-expanded') && 
              !sidebar.contains(e.target) && 
              e.target !== sidebarToggle && 
              !sidebarToggle.contains(e.target)) {
            toggleSidebar();
          }
        });
        
        // Add swipe gesture support for sidebar
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.addEventListener('touchstart', function(e) {
          touchStartX = e.changedTouches[0].screenX;
        }, false);
        
        document.addEventListener('touchend', function(e) {
          touchEndX = e.changedTouches[0].screenX;
          handleSwipe();
        }, false);
        
        function handleSwipe() {
          const sidebar = document.getElementById('sidebar');
          const swipeThreshold = 100;
          
          if (touchEndX - touchStartX > swipeThreshold) {
            // Swipe right - open sidebar
            if (!sidebar.classList.contains('sidebar-expanded')) {
              toggleSidebar();
            }
          } else if (touchStartX - touchEndX > swipeThreshold) {
            // Swipe left - close sidebar
            if (sidebar.classList.contains('sidebar-expanded')) {
              toggleSidebar();
            }
          }
        }
      });
    </script>
</body>
</html>
